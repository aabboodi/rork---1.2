import { Gift, PostGift, GiftTransaction } from '@/types';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useWalletStore } from '@/store/walletStore';

class GiftService {
  private static instance: GiftService;
  private readonly GIFTS_KEY = 'available_gifts';
  private readonly POST_GIFTS_KEY = 'post_gifts';
  private readonly GIFT_TRANSACTIONS_KEY = 'gift_transactions';

  static getInstance(): GiftService {
    if (!GiftService.instance) {
      GiftService.instance = new GiftService();
    }
    return GiftService.instance;
  }

  // Get available gifts
  async getAvailableGifts(): Promise<Gift[]> {
    try {
      const stored = await AsyncStorage.getItem(this.GIFTS_KEY);
      return stored ? JSON.parse(stored) : this.getDefaultGifts();
    } catch (error) {
      console.error('Failed to get available gifts:', error);
      return this.getDefaultGifts();
    }
  }

  // Send gift to post/clip/audio
  async sendGift(
    giftId: string,
    senderId: string,
    receiverId: string,
    postId?: string,
    clipId?: string,
    audioPostId?: string,
    customAmount?: number,
    message?: string,
    isAnonymous: boolean = false,
    visibility: 'public' | 'private' | 'friends_only' = 'public'
  ): Promise<{ success: boolean; postGift?: PostGift; error?: string }> {
    try {
      const gift = await this.getGiftById(giftId);
      if (!gift) {
        return { success: false, error: 'Gift not found' };
      }

      if (!gift.isActive) {
        return { success: false, error: 'Gift is not available' };
      }

      // Validate that at least one target is specified
      if (!postId && !clipId && !audioPostId) {
        return { success: false, error: 'Must specify a post, clip, or audio post' };
      }

      const now = Date.now();
      let finalAmount = 0;
      let transactionId: string | undefined;

      // Handle money gifts
      if (gift.type === 'money') {\n        if (gift.value && customAmount && customAmount !== gift.value) {\n          return { success: false, error: 'Custom amount not allowed for this gift' };\n        }\n\n        finalAmount = customAmount || gift.value || 0;\n        \n        if (finalAmount <= 0) {\n          return { success: false, error: 'Invalid gift amount' };\n        }\n\n        // Check sender balance\n        const walletStore = useWalletStore.getState();\n        const senderBalance = walletStore.getBalance(gift.currency || 'USD');\n        \n        if (senderBalance < finalAmount) {\n          return { success: false, error: 'Insufficient balance' };\n        }\n\n        // Create money transaction\n        const giftTransaction: GiftTransaction = {\n          id: `gift_tx_${now}_${Math.random().toString(36).substr(2, 9)}`,\n          giftId,\n          senderId,\n          receiverId,\n          postId,\n          clipId,\n          audioPostId,\n          amount: finalAmount,\n          currency: gift.currency || 'USD',\n          timestamp: now,\n          status: 'completed',\n          isAnonymous,\n          giftMessage: message\n        };\n\n        // Process payment\n        try {\n          await walletStore.updateBalance(gift.currency || 'USD', -finalAmount);\n          // In a real app, you'd credit the receiver's balance\n          // await walletStore.updateBalance(gift.currency || 'USD', finalAmount, receiverId);\n          \n          await this.saveGiftTransaction(giftTransaction);\n          transactionId = giftTransaction.id;\n        } catch (error) {\n          return { success: false, error: 'Payment processing failed' };\n        }\n      }\n\n      // Get sender info (in real app, fetch from user service)\n      const senderInfo = {\n        name: isAnonymous ? 'Anonymous' : 'User', // Would fetch real name\n        profilePicture: isAnonymous ? '' : 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face'\n      };\n\n      // Get receiver info\n      const receiverInfo = {\n        name: 'Receiver' // Would fetch real name\n      };\n\n      const postGift: PostGift = {\n        id: `post_gift_${now}_${Math.random().toString(36).substr(2, 9)}`,\n        giftId,\n        gift,\n        postId,\n        clipId,\n        audioPostId,\n        senderId: isAnonymous ? 'anonymous' : senderId,\n        senderName: senderInfo.name,\n        senderProfilePicture: senderInfo.profilePicture,\n        receiverId,\n        receiverName: receiverInfo.name,\n        amount: gift.type === 'money' ? finalAmount : undefined,\n        currency: gift.type === 'money' ? gift.currency : undefined,\n        message,\n        isAnonymous,\n        timestamp: now,\n        status: 'sent',\n        transactionId,\n        visibility,\n        giftAnimation: {\n          animationType: gift.animation || 'bounce',\n          duration: 2000,\n          effects: ['sparkle', 'glow']\n        }\n      };\n\n      await this.savePostGift(postGift);\n\n      return { success: true, postGift };\n    } catch (error) {\n      console.error('Failed to send gift:', error);\n      return { success: false, error: 'Failed to send gift' };\n    }\n  }\n\n  // Get gifts for a specific post/clip/audio\n  async getPostGifts(\n    postId?: string,\n    clipId?: string,\n    audioPostId?: string\n  ): Promise<PostGift[]> {\n    try {\n      const allPostGifts = await this.getAllPostGifts();\n      \n      return allPostGifts.filter(gift => {\n        if (postId && gift.postId === postId) return true;\n        if (clipId && gift.clipId === clipId) return true;\n        if (audioPostId && gift.audioPostId === audioPostId) return true;\n        return false;\n      }).sort((a, b) => b.timestamp - a.timestamp);\n    } catch (error) {\n      console.error('Failed to get post gifts:', error);\n      return [];\n    }\n  }\n\n  // Get total gift value for a post/clip/audio\n  async getTotalGiftValue(\n    postId?: string,\n    clipId?: string,\n    audioPostId?: string\n  ): Promise<{ [currency: string]: number }> {\n    try {\n      const gifts = await this.getPostGifts(postId, clipId, audioPostId);\n      const totals: { [currency: string]: number } = {};\n\n      for (const gift of gifts) {\n        if (gift.amount && gift.currency) {\n          totals[gift.currency] = (totals[gift.currency] || 0) + gift.amount;\n        }\n      }\n\n      return totals;\n    } catch (error) {\n      console.error('Failed to get total gift value:', error);\n      return {};\n    }\n  }\n\n  // Get gifts sent by user\n  async getUserSentGifts(userId: string): Promise<PostGift[]> {\n    try {\n      const allPostGifts = await this.getAllPostGifts();\n      return allPostGifts\n        .filter(gift => gift.senderId === userId)\n        .sort((a, b) => b.timestamp - a.timestamp);\n    } catch (error) {\n      console.error('Failed to get user sent gifts:', error);\n      return [];\n    }\n  }\n\n  // Get gifts received by user\n  async getUserReceivedGifts(userId: string): Promise<PostGift[]> {\n    try {\n      const allPostGifts = await this.getAllPostGifts();\n      return allPostGifts\n        .filter(gift => gift.receiverId === userId)\n        .sort((a, b) => b.timestamp - a.timestamp);\n    } catch (error) {\n      console.error('Failed to get user received gifts:', error);\n      return [];\n    }\n  }\n\n  // Get gift statistics for user\n  async getUserGiftStats(userId: string): Promise<{\n    totalSent: number;\n    totalReceived: number;\n    totalValueSent: { [currency: string]: number };\n    totalValueReceived: { [currency: string]: number };\n    mostPopularGiftSent: Gift | null;\n    mostPopularGiftReceived: Gift | null;\n  }> {\n    try {\n      const sentGifts = await this.getUserSentGifts(userId);\n      const receivedGifts = await this.getUserReceivedGifts(userId);\n\n      // Calculate totals\n      const totalValueSent: { [currency: string]: number } = {};\n      const totalValueReceived: { [currency: string]: number } = {};\n      const giftCountsSent: { [giftId: string]: number } = {};\n      const giftCountsReceived: { [giftId: string]: number } = {};\n\n      for (const gift of sentGifts) {\n        if (gift.amount && gift.currency) {\n          totalValueSent[gift.currency] = (totalValueSent[gift.currency] || 0) + gift.amount;\n        }\n        giftCountsSent[gift.giftId] = (giftCountsSent[gift.giftId] || 0) + 1;\n      }\n\n      for (const gift of receivedGifts) {\n        if (gift.amount && gift.currency) {\n          totalValueReceived[gift.currency] = (totalValueReceived[gift.currency] || 0) + gift.amount;\n        }\n        giftCountsReceived[gift.giftId] = (giftCountsReceived[gift.giftId] || 0) + 1;\n      }\n\n      // Find most popular gifts\n      const mostPopularSentGiftId = Object.keys(giftCountsSent).reduce((a, b) => \n        giftCountsSent[a] > giftCountsSent[b] ? a : b, Object.keys(giftCountsSent)[0]\n      );\n      const mostPopularReceivedGiftId = Object.keys(giftCountsReceived).reduce((a, b) => \n        giftCountsReceived[a] > giftCountsReceived[b] ? a : b, Object.keys(giftCountsReceived)[0]\n      );\n\n      const mostPopularGiftSent = mostPopularSentGiftId ? await this.getGiftById(mostPopularSentGiftId) : null;\n      const mostPopularGiftReceived = mostPopularReceivedGiftId ? await this.getGiftById(mostPopularReceivedGiftId) : null;\n\n      return {\n        totalSent: sentGifts.length,\n        totalReceived: receivedGifts.length,\n        totalValueSent,\n        totalValueReceived,\n        mostPopularGiftSent,\n        mostPopularGiftReceived\n      };\n    } catch (error) {\n      console.error('Failed to get user gift stats:', error);\n      return {\n        totalSent: 0,\n        totalReceived: 0,\n        totalValueSent: {},\n        totalValueReceived: {},\n        mostPopularGiftSent: null,\n        mostPopularGiftReceived: null\n      };\n    }\n  }\n\n  // Private helper methods\n  private async getGiftById(giftId: string): Promise<Gift | null> {\n    const gifts = await this.getAvailableGifts();\n    return gifts.find(gift => gift.id === giftId) || null;\n  }\n\n  private async savePostGift(postGift: PostGift): Promise<void> {\n    try {\n      const allPostGifts = await this.getAllPostGifts();\n      allPostGifts.push(postGift);\n      await AsyncStorage.setItem(this.POST_GIFTS_KEY, JSON.stringify(allPostGifts));\n    } catch (error) {\n      console.error('Failed to save post gift:', error);\n    }\n  }\n\n  private async getAllPostGifts(): Promise<PostGift[]> {\n    try {\n      const stored = await AsyncStorage.getItem(this.POST_GIFTS_KEY);\n      return stored ? JSON.parse(stored) : [];\n    } catch (error) {\n      console.error('Failed to get all post gifts:', error);\n      return [];\n    }\n  }\n\n  private async saveGiftTransaction(transaction: GiftTransaction): Promise<void> {\n    try {\n      const allTransactions = await this.getAllGiftTransactions();\n      allTransactions.push(transaction);\n      await AsyncStorage.setItem(this.GIFT_TRANSACTIONS_KEY, JSON.stringify(allTransactions));\n    } catch (error) {\n      console.error('Failed to save gift transaction:', error);\n    }\n  }\n\n  private async getAllGiftTransactions(): Promise<GiftTransaction[]> {\n    try {\n      const stored = await AsyncStorage.getItem(this.GIFT_TRANSACTIONS_KEY);\n      return stored ? JSON.parse(stored) : [];\n    } catch (error) {\n      console.error('Failed to get all gift transactions:', error);\n      return [];\n    }\n  }\n\n  // Default gifts for the platform\n  private getDefaultGifts(): Gift[] {\n    return [\n      // Virtual Gifts\n      {\n        id: 'heart',\n        type: 'virtual',\n        name: '‚ù§Ô∏è Heart',\n        description: 'Show some love',\n        icon: '‚ù§Ô∏è',\n        animation: 'pulse',\n        category: 'emoji',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'fire',\n        type: 'virtual',\n        name: 'üî• Fire',\n        description: 'This is fire!',\n        icon: 'üî•',\n        animation: 'flicker',\n        category: 'emoji',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'clap',\n        type: 'virtual',\n        name: 'üëè Clap',\n        description: 'Amazing work!',\n        icon: 'üëè',\n        animation: 'bounce',\n        category: 'emoji',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'star',\n        type: 'virtual',\n        name: '‚≠ê Star',\n        description: 'You\\'re a star!',\n        icon: '‚≠ê',\n        animation: 'twinkle',\n        category: 'emoji',\n        rarity: 'rare',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'crown',\n        type: 'virtual',\n        name: 'üëë Crown',\n        description: 'Royalty treatment',\n        icon: 'üëë',\n        animation: 'glow',\n        category: 'emoji',\n        rarity: 'epic',\n        cost: 100,\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'diamond',\n        type: 'virtual',\n        name: 'üíé Diamond',\n        description: 'Precious content',\n        icon: 'üíé',\n        animation: 'sparkle',\n        category: 'emoji',\n        rarity: 'legendary',\n        cost: 500,\n        isActive: true,\n        createdAt: Date.now()\n      },\n      \n      // Money Gifts\n      {\n        id: 'coffee',\n        type: 'money',\n        name: '‚òï Coffee',\n        description: 'Buy them a coffee',\n        icon: '‚òï',\n        animation: 'steam',\n        value: 5,\n        currency: 'USD',\n        category: 'money',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'pizza',\n        type: 'money',\n        name: 'üçï Pizza',\n        description: 'Treat them to pizza',\n        icon: 'üçï',\n        animation: 'bounce',\n        value: 15,\n        currency: 'USD',\n        category: 'money',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'custom_money',\n        type: 'money',\n        name: 'üí∞ Custom Amount',\n        description: 'Send any amount',\n        icon: 'üí∞',\n        animation: 'rain',\n        category: 'money',\n        rarity: 'common',\n        isActive: true,\n        createdAt: Date.now()\n      },\n      \n      // Premium Animated Gifts\n      {\n        id: 'fireworks',\n        type: 'virtual',\n        name: 'üéÜ Fireworks',\n        description: 'Celebrate in style',\n        icon: 'üéÜ',\n        animation: 'explode',\n        category: 'animation',\n        rarity: 'epic',\n        cost: 200,\n        isActive: true,\n        createdAt: Date.now()\n      },\n      {\n        id: 'rainbow',\n        type: 'virtual',\n        name: 'üåà Rainbow',\n        description: 'Spread the colors',\n        icon: 'üåà',\n        animation: 'arc',\n        category: 'animation',\n        rarity: 'rare',\n        cost: 150,\n        isActive: true,\n        createdAt: Date.now()\n      }\n    ];\n  }\n}\n\nexport default GiftService;